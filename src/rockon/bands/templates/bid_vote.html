{% extends "base.html" %}
{% block content %}
    {% load static %}
    {% load compress %}
    {% csrf_token %}
    <h1>Bandbewertung</h1>
    {% compress js file vue %}
        <script src="{% static 'vendor/vue.global.3.5.22.min.js' %}"></script>
    {% endcompress %}
    {% compress js file wavesurfer %}
        <script src="{% static "vendor/wavesurfer.7.5.0.min.js" %}"></script>
    {% endcompress %}
    {% compress js file simplelightbox %}
        <script src="{% static "vendor/simple-lightbox.2.13.0.min.js" %}"></script>
    {% endcompress %}
    {% compress css file simplelightbox %}
        <link rel="stylesheet" type="text/css" href="{% static "vendor/simple-lightbox.2.13.0.min.css" %}">
    {% endcompress %}
    <script nonce="{{ request.csp_nonce }}">
        window.rockon_data = {
            event_slug: "{{ current_event.slug }}",
            tracks: {{ tracks }},
            federal_states: {{ federal_states }},
            bid_states: {{ bid_states }},
            selectedTrackId: {{ trackid }},
            selectedBand: {{ bandid }},
            user_votes: {{ user_votes }},
            placeholder: "{% static 'assets/4_3_placeholder.webp' %}",
            media_offline: "{% static 'assets/media-offline.webp' %}"
        }
        window.rockon_api = {
            list_bands: "{% url "bands-list" %}",
            update_band: "{% url "bands-detail" pk="pk_placeholder" %}",
            fetch_rating: "{% url 'band-votes-detail' pk='pk_placeholder' %}",
            comments_api: "{% url 'band-comments-list' %}",
            band_vote: "{% url 'band-votes-perform-create' %}",
            allow_changes: {{ allow_changes }},
            allow_votes: {{ allow_votes }},
        }
    </script>
    {% verbatim %}
    <div id="app">
        <track-list :tracks="tracks" :bands="bands" :selected-track="selectedTrack" :show-band-no-name="showBandNoName"
                    :show-incomplete-bids="showIncompleteBids" :show-declined-bids="showDeclinedBids"
                    :bid-states="bidStates"
                    @select-track="selectTrack" @filter-no-name="handleFilterShowBandNoNameChange"
                    @filter-incomplete-bids="handleFilterIncompleteBidsChange"
                    @filter-declined-bids="handleFilterDeclinedBidsChange">
        </track-list>
        <loading-spinner v-if="!bandListLoaded" :bands-to-fetch="bandsToFetch" :bands="bands"></loading-spinner>
        <band-list v-if="bandListLoaded && !selectedBand" :bands="bands" :selected-track="selectedTrack"
                   :show-band-no-name="showBandNoName" :show-incomplete-bids="showIncompleteBids"
                   :show-declined-bids="showDeclinedBids" @select-band="selectBand" :federal-states="federalStates"
                   :user-votes="userVotes"></band-list>
        <band-details v-if="bandDetailLoaded && selectedBandDetails" :selected-band-details="selectedBandDetails"
                      :allow-votes="allowVotes" :allow-changes="allowChanges" :tracks="tracks"
                      :federal-states="federalStates" :comment-api="bandCommentsUrl" @update:track="updateTrack"
                      @update:select-song="handleSongSelect" @update:rating="setRating" :bid-states="bidStates"
                      @update:bid-status="updateBidStatus"></band-details>
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div class="toast-container position-fixed bottom-0 end-0 p-3">
                <div id="toastAudioPlayer"
                     class="toast"
                     role="alert"
                     aria-live="assertive"
                     aria-atomic="true"
                     data-bs-autohide="false">
                    <div class="toast-header">
                        <strong class="me-auto">
                            <i class="fas fa-music" style="padding-right: 0.5em;"></i>
                            <span v-if="toastIsMaximized">Rockify</span>
                            <div v-else class="scrolling-container">
                                <div class="scrolling-text-wrapper">
                                    <span class="scrolling-text"><a href="#" @click.prevent="navigateToPlayingBand" class="band-link">{{ playSongBand.name || playSongBand.guid || "" }}</a> - {{ playSong.file_name_original }}</span>
                                </div>
                            </div>
                        </strong>
                        <button class="btn"
                                style="color: var(--rockon-btn-close-color)"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#player-toast-body"
                                :aria-expanded="toastIsMaximized"
                                aria-controls="player-toast-body"
                                @click="toggleIcon"
                                title="Minimieren">
                            <i :class="toastIsMaximized ? 'fas fa-chevron-down' : 'fas fa-chevron-up'"></i>
                        </button>
                        <button type="button"
                                class="btn-close"
                                data-bs-dismiss="toast"
                                aria-label="Close"
                                @click="handleCloseClick"
                                title="Schließen"></button>
                    </div>
                    <div id="player-toast-body"
                         :class="['collapse', { 'show': toastIsMaximized }]">
                        <div class="toast-body">
                            <song-info v-if="playSong" :song="playSong" :band="playSongBand" @navigate-to-band="navigateToPlayingBand"></song-info>
                            <div id="player-wrapper"></div>
                            <div class="d-flex justify-content-center gap-2 mt-2">
                                <button type="button" class="btn btn-sm btn-player-control" @click="playPreviousTrack" :disabled="!canPlayPrevious" title="Vorheriger Track">
                                    <i class="fa-solid fa-backward-step"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-player-control" @click="playNextTrack" :disabled="!canPlayNext" title="Nächster Track">
                                    <i class="fa-solid fa-forward-step"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endverbatim %}
    <style scoped>
        .highlight {
            color: #fff300;
        }

        .image-container {
            overflow: hidden;
            /* Optimize for repaints */
            contain: layout style paint;
            position: relative;
            height: 250px;
            background-color: #2a2a2a;
        }

        /* Skeleton loading placeholder */
        .skeleton-loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                #2a2a2a 0%,
                #3a3a3a 50%,
                #2a2a2a 100%
            );
            background-size: 200% 100%;
            animation: skeleton-pulse 1.5s ease-in-out infinite;
        }

        @keyframes skeleton-pulse {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        /* Detail page image skeleton */
        .detail-image-container {
            position: relative;
            min-height: 200px;
            min-width: 200px;
            max-height: 250px;
            display: inline-block;
            background-color: #2a2a2a;
            border-radius: 4px;
            overflow: hidden;
            transition: background-color 0.3s ease-in-out;
        }

        .detail-image-container.loaded {
            background-color: transparent;
        }

        .detail-image {
            max-height: 250px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .detail-image.loaded {
            opacity: 1;
        }

        .zoom-image {
            transition: transform 0.6s ease-in-out, opacity 0.3s ease-in-out;
            transform: scale(1);
            /* GPU acceleration for smoother animations */
            will-change: transform;
            backface-visibility: hidden;
            opacity: 0;
        }

        .zoom-image.loaded {
            opacity: 1;
        }

        .card:hover .zoom-image.loaded {
            transform: scale(1.1);
        }

        /* Optimize card rendering for large lists */
        .card-group {
            contain: layout style;
        }

        @keyframes scroll {
            0% {
                transform: translateX(0);
            }
            50% {
                transform: translateX(calc(-100% + 230px));
            }
            100% {
                transform: translateX(0);
            }
        }

        .scrolling-text-wrapper {
            display: flex;
            width: max-content;
            animation: scroll 15s linear infinite;
        }

        .scrolling-container {
            width: 230px; /* Adjust the width as needed */
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
            position: relative;
        }

        .scrolling-text {
            white-space: nowrap;
        }

        /* Player control buttons */
        .btn-player-control {
            color: #fff300;
            border-color: #fff300;
            transition: all 0.2s ease;
        }

        .btn-player-control:hover:not(:disabled) {
            background-color: #fff300;
            color: #000;
        }

        .btn-player-control:disabled {
            color: #666;
            border-color: #444;
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Prevent page jump when scrollbar appears/disappears */
        html {
            overflow-y: scroll;
        }

        /* Filter badge styles */
        .filter-badge {
            font-size: 0.9rem;
            padding: 0.5em 0.75em;
            border: 2px solid #fff300 !important;
        }

        /* Status filter dropdown */
        .status-filter-dropdown {
            font-size: 0.9rem;
            border: 2px solid #fff300 !important;
            border-radius: 0.375rem;
            vertical-align: middle;
            transition: all 0.2s ease;
        }

        .status-filter-dropdown:focus {
            border-color: #fff300 !important;
            box-shadow: 0 0 0 0.25rem rgba(255, 243, 0, 0.25) !important;
        }

        .status-filter-dropdown.bg-success {
            background-color: #fff300 !important;
            color: #000 !important;
            border-color: #fff300 !important;
        }

        .status-filter-dropdown.bg-success option {
            background-color: #fff;
            color: #000;
        }

        /* Inactive badges - outline yellow */
        .text-bg-outline-primary,
        .filter-badge.text-bg-primary {
            background-color: transparent !important;
            border: 2px solid #fff300 !important;
            color: #fff300 !important;
        }

        .text-bg-outline-primary:hover,
        .filter-badge.text-bg-primary:hover {
            background-color: rgba(255, 243, 0, 0.2) !important;
        }

        /* Active filter/track state - filled yellow */
        .filter-badge.text-bg-success {
            background-color: #fff300 !important;
            color: #000 !important;
            border: 2px solid #fff300 !important;
        }

        /* Filter options container */
        .filter-options-container {
            padding-left: 1rem;
        }

        /* Form switch styling - ensure checked state is visible */
        .form-check-input:checked {
            background-color: #198754 !important;
            border-color: #198754 !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e") !important;
        }

        .form-check-input {
            cursor: pointer;
        }

        .form-check-label {
            cursor: pointer;
        }

        /* Band link in player toast */
        .band-link {
            color: #fff300 !important;
            text-decoration: none;
            cursor: pointer;
        }

        .band-link:hover {
            text-decoration: underline;
        }
    </style>
    {% compress js file voting %}
        <script src="{% static 'js/voting.js' %}"></script>
    {% endcompress %}
{% endblock content %}
