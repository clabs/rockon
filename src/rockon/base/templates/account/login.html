{% extends "base.html" %} {% block content %}
    {% load static %}{% load compress %}
    {% compress js file vue %}
        <script src="{% static 'vendor/vue.global.3.5.22.min.js' %}"></script>
    {% endcompress %}
    {% compress js file login_vue %}
        <script src="{% static 'js/login.vue.js' %}"></script>
    {% endcompress %}

    <script type="text/javascript" nonce="{{ request.csp_nonce }}">
        window.rockon_data = {
            accountContext: "{{ account_context }}",
        }
        window.rockon_api = {
            createAccount: "{% url "apiv2:account_create" %}",
            requestMagicLink: "{% url "apiv2:request_magic_link" %}",
            accountCreatedRedirect: "{% url "base:account_created" %}",
            privacyUrl: "{% url "rockon_privacy" %}",
            csrfToken: "{{ csrf_token }}",
        }
    </script>

    {% verbatim %}
    <div id="app" v-cloak>

        <!-- ==================== LOGIN PANEL ==================== -->
        <transition name="fade" mode="out-in">
        <section v-if="activePanel === 'login'" key="login" class="row justify-content-center">
            <div class="col-lg-5 col-md-7 col-sm-10">
                <div class="p-4 form-section">
                    <div class="text-center mb-4">
                        <h2>Einloggen</h2>
                        <p class="text-white mb-0">
                            Wir schicken dir einen Magic-Link per E-Mail, mit dem du dich sofort einloggen kannst.
                        </p>
                    </div>

                    <form @submit.prevent="requestMagicLink">
                        <div class="mb-3">
                            <label for="login_email" class="form-label">E-Mail Adresse</label>
                            <input type="email"
                                   id="login_email"
                                   class="form-control form-control-lg"
                                   :class="loginEmailClass"
                                   v-model="loginForm.email"
                                   @blur="touchLogin"
                                   @keyup="touchLogin"
                                   placeholder="jane.doe@example.net"
                                   autocomplete="email"
                                   :disabled="loginForm.sent"
                                   autofocus />
                            <div class="invalid-feedback">Bitte gib eine g√ºltige E-Mail Adresse an.</div>
                            <small class="form-text text-white">
                                Bereits erhaltene Links laufen nicht ab.
                            </small>
                        </div>

                        <button type="submit"
                                class="btn btn-primary btn-lg w-100"
                                :disabled="!loginCanSubmit">
                            <span v-if="loginForm.loading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            Magic-Link anfordern
                        </button>
                    </form>

                    <!-- Success message -->
                    <div v-if="loginForm.sent" class="alert alert-primary mt-3" role="alert">
                        <h5 class="alert-heading">ü™Ñ Magic-Link versandt</h5>
                        <p>
                            Wir haben dir eine Mail mit einem Magic-Link zugeschickt. Bitte √ºberpr√ºfe
                            in den n√§chsten Minuten dein Postfach.
                        </p>
                        <hr>
                        <p class="mb-0">
                            ‚ö†Ô∏è Im Zweifel auch den Spam-Ordner checken. Bei Problemen melde dich bei
                            <a href="mailto:rockon@cpye.de">rockon@cpye.de</a>.
                        </p>
                    </div>

                    <!-- Error: unknown email -->
                    <div v-if="loginForm.error === 'unknown'" class="alert alert-danger mt-3" role="alert">
                        Diese E-Mail-Adresse ist unbekannt. Falls du Hilfe beim Login ben√∂tigst, wende dich an
                        <a href="mailto:crew@rocktreff.de">crew@rocktreff.de</a>.
                    </div>

                    <!-- Error: network -->
                    <div v-if="loginForm.error === 'network'" class="alert alert-danger mt-3" role="alert">
                        Es ist ein Netzwerkfehler aufgetreten. Bitte versuche es sp√§ter erneut.
                    </div>

                    <!-- Switch to signup -->
                    <div class="text-center mt-4 pt-3 border-top border-secondary">
                        <span class="text-white">Noch keinen Account?</span>
                        <a href="#" @click.prevent="setPanel('signup')" class="ms-1 fw-semibold">Jetzt registrieren</a>
                    </div>
                </div>
            </div>
        </section>

        <!-- ==================== SIGNUP PANEL ==================== -->
        <section v-else key="signup" class="row justify-content-center">
            <div class="col-lg-6 col-md-8 col-sm-10">
                <div class="p-4 form-section">
                    <div class="text-center mb-4">
                        <h2>Account erstellen</h2>
                        <p class="text-white mb-0">
                            Du brauchst nur deine E-Mail-Adresse.
                        </p>
                    </div>

                    <form @submit.prevent="createAccount">
                        <!-- Email fields -->
                        <div class="mb-3">
                            <label for="signup_email" class="form-label">E-Mail Adresse</label>
                            <input type="email"
                                   id="signup_email"
                                   class="form-control form-control-lg"
                                   :class="signupFieldClass('email')"
                                   v-model="signupForm.email"
                                   @blur="touchSignup('email')"
                                   placeholder="jane.doe@example.net"
                                   autocomplete="email"
                                   :disabled="signupForm.loading" />
                            <div class="invalid-feedback">Bitte gib eine g√ºltige E-Mail Adresse an.</div>
                        </div>
                        <div class="mb-3">
                            <label for="signup_email_confirm" class="form-label">E-Mail Adresse best√§tigen</label>
                            <input type="email"
                                   id="signup_email_confirm"
                                   class="form-control form-control-lg"
                                   :class="signupFieldClass('emailConfirm')"
                                   v-model="signupForm.emailConfirm"
                                   @blur="touchSignup('emailConfirm')"
                                   placeholder="jane.doe@example.net"
                                   autocomplete="off"
                                   :disabled="signupForm.loading" />
                            <div class="invalid-feedback">Die E-Mail Adressen stimmen nicht √ºberein.</div>
                        </div>

                        <!-- Consent checkboxes -->
                        <h6 class="mt-4 mb-3 text-white text-uppercase" style="letter-spacing:.05em">Rechtliches</h6>

                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input"
                                   :class="signupFieldClass('allowContact')"
                                   type="checkbox"
                                   role="switch"
                                   id="signup_allow_contact"
                                   v-model="signupForm.allowContact"
                                   @change="touchSignup('allowContact')"
                                   :disabled="signupForm.loading" />
                            <label class="form-check-label" for="signup_allow_contact">
                                Ich bin damit einverstanden, dass der CPYE e.V. mich f√ºr Dinge rund um den Rocktreff
                                und das Spielfest kontaktieren darf.
                            </label>
                            <div class="invalid-feedback">Bitte erlaube uns, dich zu kontaktieren.</div>
                        </div>

                        <div class="form-check form-switch mb-4">
                            <input class="form-check-input"
                                   :class="signupFieldClass('readPrivacy')"
                                   type="checkbox"
                                   role="switch"
                                   id="signup_read_privacy"
                                   v-model="signupForm.readPrivacy"
                                   @change="touchSignup('readPrivacy')"
                                   :disabled="signupForm.loading" />
                            <label class="form-check-label" for="signup_read_privacy">
                                Ich habe die
                                <a :href="privacyUrl" target="_blank">Datenschutzbestimmungen</a>
                                zur Kenntnis genommen und erkl√§re mich mit der Speicherung und Verarbeitung
                                personenbezogener Daten im Rahmen der Veranstaltungen Rocktreff und Spielfest
                                einverstanden.
                            </label>
                            <div class="invalid-feedback">Bitte best√§tige, dass du die Datenschutzbestimmungen gelesen hast.</div>
                        </div>

                        <button type="submit"
                                class="btn btn-primary btn-lg w-100"
                                :disabled="!signupCanSubmit">
                            <span v-if="signupForm.loading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            Account erstellen
                        </button>
                    </form>

                    <!-- Error: already exists -->
                    <div v-if="signupForm.error === 'exists'" class="alert alert-warning mt-3" role="alert">
                        Diese E-Mail-Adresse ist bereits registriert.
                        <a href="#" @click.prevent="setPanel('login')"><strong>Zum Login wechseln</strong></a>
                        und einen Magic-Link anfordern.
                    </div>

                    <!-- Error: unknown -->
                    <div v-if="signupForm.error === 'unknown'" class="alert alert-danger mt-3" role="alert">
                        Es ist ein unbekannter Fehler aufgetreten. Bitte versuche es sp√§ter erneut oder kontaktiere
                        <a href="mailto:crew@rocktreff.de">crew@rocktreff.de</a>.
                    </div>

                    <!-- Error: network -->
                    <div v-if="signupForm.error === 'network'" class="alert alert-danger mt-3" role="alert">
                        Es ist ein Netzwerkfehler aufgetreten. Bitte √ºberpr√ºfe deine Verbindung und versuche es erneut.
                    </div>

                    <!-- Switch to login -->
                    <div class="text-center mt-4 pt-3 border-top border-secondary">
                        <span class="text-white">Bereits einen Account?</span>
                        <a href="#" @click.prevent="setPanel('login')" class="ms-1 fw-semibold">Einloggen</a>
                    </div>
                </div>
            </div>
        </section>
        </transition>
    </div>
    {% endverbatim %}

{% endblock content %}
